### Иллюстрация работы будущего Telegram-бота (понятным языком)

---

#### 1. Подключаем работника

1. Работник открывает бота и жмёт **/start**.
2. Мы (админы) видим уведомление *«Новая заявка от @username»* с кнопками **✅ Одобрить / ❌ Отклонить**.
3. Нажимаем **✅ Одобрить** → работник сразу получает свой **личный кабинет**.

---

#### 2. Что видит работник в кабинете

```
👤 Ваши цифры
— Клиентов: 7
— Баланс: 3 250 ₽

[➕ Добавить клиента]   [💸 Запросить выплату]
```

---

#### 3. Работник приводит нового клиента

1. Жмёт **«➕ Добавить клиента»**.
2. Бот задаёт вопросы один за другим:
 • телефон клиента →
 • ФИО →
 • мессенджер (Telegram / WhatsApp / другое) →
 • что хочет купить (ссылка или текст) →
 • сумма заказа →
 • статус: «хочет купить / ждём оплаты / оплатил».
3. Если выбран **«Оплатил»**, бот просит прикрепить фото / PDF чека.
4. Работник проверяет краткое резюме данных и нажимает **«Сохранить»**.
5. Бот записывает строку в лист **Clients** Google-таблицы.

---

#### 4. Что происходит в таблице автоматически

* **Clients**: появляется новая строка с телефоном, суммой, статусом, ссылкой на чек.
* **Workers**:
   • счётчик «Клиентов» +1;
   • к балансу прибавляется комиссия (5 % до 10 клиентов, потом 10 %).
* Вся арифметика лежит в формулах таблицы – цифры сходятся сразу.

---

#### 5. Админ всё видит «вживую»

* В **Clients** видно, какой работник привёл клиента и сколько тот заплатил.
* В **Workers** видно, сколько у каждого баланса.
* Ничего вручную считать не нужно – таблица сама.

---

#### 6. Запрос на выплату

1. Работник в кабинете жмёт **«💸 Запросить выплату»**.
2. Вводит сумму (не выше текущего баланса).
3. Бот добавляет строку в лист **Withdrawals** со статусом `PENDING` и уведомляет админов.

---

#### 7. Админ подтверждает выплату

1. В боте команда **/admin** → раздел «Заявки на вывод».
2. Видим список:
 `@username — 3 000 ₽ — PENDING` → кнопки **✅ Выплатил / ❌ Отказ**.
3. Нажимаем **✅** →
 • строка в **Withdrawals** становится `DONE`;
 • бот пишет работнику «✅ Выплата 3 000 ₽ подтверждена».
4. (Если отказ – статус `DECLINED`, баланс возвращается.)

---

#### 8. Повышенный процент

* Как только в графе «Клиентов» работника становится 10 и больше, формула автоматически подменяет процент с 5 % на 10 % для всех следующих заказов.
* Работник сразу видит, что новые продажи приносят больше.

---

### Что важно

1. **Никаких отдельных баз** – всё в одной Google-таблице.
2. **Прозрачность** – можно вручную поправить данные, если что-то ввели неправильно.
3. **Гибкость** – захотели менять проценты или добавлять ещё статусы – редактируем таблицу, код трогать не надо.
4. **Резерв копий** – Google автоматически хранит историю изменений.


## Тех-задание (prompt) для нейросети: **сгенерировать код всех модулей**

### Контекст

* Python 3.10
* Используемые внешние пакеты: `pytelegrambotapi` (telebot ≥0.0.5), `gspread` (≥6.2.1), `google-api-python-client`, `python-dotenv`, `requests`
* Кроме Google Sheets/Drive **никаких** БД и ORM.
* Структура и названия листов уже созданы: **Workers / Clients / Withdrawals** (см. таблицу ниже).
* Логику тестов и деплой не генерировать.

---

### Файловая структура, для которой нужен код

```
bot/
  __main__.py
  config.py
  sheets.py
  handlers/
      start.py
      worker.py
      admin.py
  services/
      commission.py
      receipts.py
  utils/
      validators.py
```

---

### 1. `config.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * Загрузить .env.
# * Предоставить строго типизированные константы:
#   BOT_TOKEN:str, ADMIN_IDS:list[int], SPREADSHEET_ID:str,
#   GSPREAD_CREDENTIALS:str, REPLY_TIMEOUT:int (=10).
# * Бросить RuntimeError, если BOT_TOKEN или SPREADSHEET_ID пусты.
# ------------------------------------------------------------------------------
```

---

### 2. `sheets.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * Авторизоваться через service_account(filename=GSPREAD_CREDENTIALS).
# * Функция sh() -> gspread.Spreadsheet (кэшировать).
# * helpers: workers_ws(), clients_ws(), withdrawals_ws().
# * CRUD-функции:
#   get_worker(tg_id:int) -> dict|None
#   add_worker(tg_id:int, username:str)
#   approve_worker(tg_id:int)
#   inc_balance(tg_id:int, delta:float)
#   inc_clients_count(tg_id:int)
#   append_client_row(data:dict)  # см. schema
#   create_withdrawal(tg_id:int, amount:float) -> int  # возвращает id
#   update_withdrawal(id:int, status:str)
# * Внутри – минимум 1 перечитывание листа, далее update_cell/append_row.
#   ID для Withdrawals – авто-инкремент (max+1).
# * Ленивая инициализация, retry 429 с back-off (до 3 раз).
# ------------------------------------------------------------------------------
```

---

### 3. `services/commission.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * THRESHOLDS = [(10, 0.05), (99999, 0.10)]  # ≤10 клиентов → 5 %, далее 10 %
# * calc(clients_count:int, amount:float) -> float  # округляет 2 знака
# ------------------------------------------------------------------------------
```

---

### 4. `services/receipts.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * save_receipt(bot:TeleBot, file_id:str) -> str
#   1. bot.get_file → download_file → сохранить во временный файл.
#   2. Залить в Google Drive (папка "Receipts", создать при первом вызове).
#   3. Сделать файлу доступ «Anyone with the link > Viewer».
#   4. Вернуть share-URL.
# * delete_tmp_files()  # очистка /tmp раз в сутки (cron-like внутри модуля).
# ------------------------------------------------------------------------------
```

---

### 5. `utils/validators.py`

```python
PHONE_RGX   = r"^\d{10,15}$"
MONEY_RGX   = r"^\d+(?:[.,]\d{1,2})?$"
URL_RGX     = r"^https?://"
is_phone(s) -> bool
is_money(s) -> bool   # нормализует «,»→«.»
```

---

### 6. `handlers/start.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * /start
#   if tg_id in ADMIN_IDS → msg: «Вы админ, /admin для панели».
#   else:
#     worker = sheets.get_worker(tg_id)
#     if worker and worker["role"]=="worker": show_cabinet()
#     elif worker and worker["role"]=="pending": msg «Заявка на рассмотрении».
#     else: sheets.add_worker(..., role=pending); уведомить всех админов
#       (inline-кнопки ✅ / ❌).  ✅ → approve_worker.
# ------------------------------------------------------------------------------
```

---

### 7. `handlers/worker.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * /cabinet – показать баланс и клиентов.
# * Inline «➕ Добавить клиента» → FSM:
#   phone → name → messenger (inline) → order_link → amount → status → [чек]
#   После подтверждения: sheets.append_client_row(), sheets.inc_balance(),
#   sheets.inc_clients_count(); уведомить админов «Новый клиент …».
# * «💸 Запросить выплату»:
#   - спросить сумму (валидация, баланс >=).
#   - sheets.create_withdrawal(); уведомить админов.
# ------------------------------------------------------------------------------
```

---

### 8. `handlers/admin.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# /admin меню:
#   1. «Топ workers» – взять sheets.workers_ws(), отсортировать по balance.
#   2. «Заявки на вывод» – лист Withdrawals where status=PENDING.
#      inline-кнопки ✅ / ❌ → sheets.update_withdrawal(id,"DONE"/"DECLINED");
#      при ✅ → уведомить работника.
#   3. «Экспорт CSV» – собрать Withdrawals DONE → tempfile → send_document.
# ------------------------------------------------------------------------------
```

---

### 9. `__main__.py`

```python
# ─── Responsibilities ─────────────────────────────────────────────────────────
# * Настроить logging.basicConfig(level=INFO)
# * Инициализировать TeleBot(BOT_TOKEN, parse_mode="HTML")
# * Импортировать все модуль-handlers, чтобы зарегистрировать их.
# * bot.infinity_polling(timeout=REPLY_TIMEOUT)
# ------------------------------------------------------------------------------
```

---

### Дополнительные требования к коду, которые должна соблюдать нейросеть

1. **Никакой SQLite / ORM** – только Google Sheets.
2. Все функции должны иметь **type hints**.
3. Логика retry при ошибках 429 / 503 Google API.
4. Баланс округляется до 2 знаков, суммы хранятся как `float`.
5. `receipts.py` обязан удалять временные файлы (`tempfile` + cron-like в модуле).
6. Все regex-валидации выведены в `utils.validators`.
7. Для FSM используем встроенный FSMManager telebot (v4).
8. Код читабелен: ≤80 символов в строке, docstring к каждой публичной функции.

